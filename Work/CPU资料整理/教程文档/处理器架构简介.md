# 1 处理器架构简介

- 可参考资源（记得删）
    - https://bookdown.org/loongson/_book3/
    - https://bookdown.org/ghostboy316/bookdown/404.html
    - https://www.zhihu.com/people/wen-jin-yuan-07-13/posts
    - https://www.zhihu.com/people/xiang-da-lao-men-xue-xi/posts
    - https://www.cnblogs.com/myseries/p/14458367.html
    - https://howardlau.me/programming/processor-microarchitecture.html
    - https://www.cnblogs.com/lyc-seu
- 由于简单的五级流水线CPU的设计已经有大量的书籍进行介绍，本文将更侧重于介绍一些超标量处理器的相关技术知识
- 本文的根本目的在于为[实践文档]()提供一个较为简洁的处理器技术蓝图，避免读者陷入不必要的工程细节

## 1.1 普通处理器流水线

-   流水线的概念来源于工业制造领域，以汽车装配为例来解释流水线的工作方式，假设装配一辆汽车需要四个步骤：

    -   第一步冲压：制作车身外壳和底盘等部件。
    -   第二步焊接：将冲压成形后的各部件焊接成车身。
    -   第三步涂装：将车身等主要部件清洗、化学处理、打磨、喷漆和烘干。
    -   第四步总装：将各部件（包括发动机和向外采购的零部件）组装成车。

    汽车装配则同时对应需要冲压、焊接、涂装和总装四个工人。最简单的方法是一辆汽车依次经过上述四个步骤装配完成之后，下一辆汽车才开始进行装配，最早期的工业制造就是采用的这种原始的方式，即同一时刻只有一辆汽车在装配。不久之后人们发现，某个时段中一辆汽车在进行装配时，其它三个工人都处于闲置状态，显然这是对资源的极大浪费，于是思考出能有效利用资源的新方法，即在**第一辆汽车经过冲压进入焊接工序的时候，立刻开始进行第二辆汽车的冲压，而不是等到第一辆汽车经过全部四个工序后才开始，这样在后续生产中就能够保证四个工人一直处于运行状态，不会造成人员的闲置**。这样的生产方式就好似流水川流不息，因此被称为流水线。

-   经典五级流水线：

    -   **取指：**指令取指（Instruction Fetch）是指将指令从存储器中读取出来的过程。
    -   **译码：**指令译码（Instruction Decode）是指将存储器中取出的指令进行翻译的过程。经过译码之后得到指令需要的操作数寄存器索引，可以使用此索引从通用寄存器组（Register File）中将操作数读出。
    -   **执行：**指令译码之后所需要进行的计算类型都已得知，并且已经从通用寄存器组中读取出了所需的操作数，那么接下来便进行指令执行（Instruction Execute）。指令执行是指对指令进行真正运算的过程。譬如，如果指令是一条加法运算指令，则对操作数进行加法操作；如果是减法运算指令，则进行减法操作。在“执行”阶段的最常见部件为算术逻辑部件运算器（Arithmetic Logical Unit，ALU），作为实施具体运算的硬件功能单元。
    -   **访存：**存储器访问指令往往是指令集中最重要的指令类型之一，访存（Memory Access）是指存储器访问指令将数据从存储器中读出，或者写入存储器的过程。
    -   **写回：**写回（Write-Back）是指将指令执行的结果写回通用寄存器组的过程。如果是普通运算指令，该结果值来自于“执行”阶段计算的结果；如果是存储器读指令，该结果来自于“访存”阶段从存储器中读取出来的数据。

-   与单周期流水线对比

    ![](assets/5%E7%BA%A7%E6%B5%81%E6%B0%B4%E7%BA%BF%E4%B8%8E%E5%8D%95%E5%91%A8%E6%9C%9F%E5%AF%B9%E6%AF%94)

## 1.2 超标量处理器流水线

### 1.2.1 什么是超标量

-   有2种方法提高处理器单周期指令数：

    1.   超长指令字（Very Long Instruction Word，VLIW），依靠编译器决定哪些指令可以并行执行

    2.   超标量，硬件实现指令级并行

-   单周期取出多条指令执行且用硬件对指令进行调度的处理器即为超标量处理器，分为顺序执行和乱序执行两种，注意乱序执行在取指译码（乱序很难且无意义）以及提交（即指令被允许修改处理器状态如D-Cache，顺序以保证程序顺序且实现精确异常）时也是顺序执行。只要操作数准备好即可将指令乱序发射进FU（Function Unit）中乱序执行，通过寄存器重命名将ARF（Architecture Register File）动态转化为PRF（Physical Register File）实现乱序写回。

-   另外，再进一步了解超标量流水线之前，还应了解**hazard（冒险）**的概念，超标量处理器很多设计就是为了缓解如下问题。冒险分为：
    1.   控制冒险（跳转指令引起的，无法跟据PC地址紧凑的确定下一条指令位置，取到流水线），一般靠分支预测解决。
    2.   资源冒险（比如2个add指令，都要占用ALU），一般靠在合适位置增加资源数量（如增加ALU数量）解决。
    3.   数据冒险（RAW，WAW，WAR），一般靠重命名解决WAW，WAR。至于RAW，通过旁路网络解决。

### 1.2.2 顺序超标量处理器

-   顺序超标量处理器能够在一个时钟周期内同时执行多条指令，一定程度上解决了**资源冒险**问题。比如，当指令之间没有依赖关系时，它们可以被并行执行，这显著提高了处理器的吞吐量和性能。处理器会从指令流中提取相邻多条无冲突的指令，并根据它们的类型和需求，将它们分派到不同的执行单元。这些执行单元可能包括多个算术逻辑单元（ALU）、浮点单元（FPU）等。
-   尽管指令流可能没有显式的依赖关系，但处理器必须检查并确保指令之间不存在隐含的依赖关系。例如，如果一条指令的结果被另一条指令使用，处理器必须确保先后续指令可通过旁路网络或其他手段获得该运算结果。由于存在多条执行管线，这个过程需要复杂的依赖性检查机制。
-   为保证写回阶段顺序执行，3个FU（分别负责ALU、存储器类型、乘法三种指令的运算）需经历同样周期数流水线。一般的，顺序超标量处理器采用ScoreBoard记录每条指令的执行情况。
-   顺序超标量处理器的局限性在于仍没有解决**数据冒险**问题，WAW和WAR冲突仍然是制约指令并行性的关键问题（尽管在顺序处理器中WAR是一个假冲突，但这也是为什么需要顺序执行的根本原因。此外相较于乱序执行，顺序执行一定程度上降低了处理器计算资源的利用效率）
-   TODO：图片

### 1.2.3 乱序超标量处理器

-   乱序处理器一般靠重命名解决WAW，WAR**数据冲突**。为解决WAW和WAR相关性，译码器阶段重命名寄存器将ARF映射到数量更多的PRF。发射阶段指令被存入发射队列，源操作数准备好即被发射到对应FU中执行，而后乱序写回PRF，而由于分支预测失败或异常，PRF结果可能不会全部写入APF，故PRF也被称为future file。而后再通过重排序缓存ROB将结果从PRF顺序提交至ARF，不处于分支预测失败或异常路径则顺利退休。

-   乱序处理器的流水段划分：

    1.   取指（fetch）：主要有两步，先由分支预测器决定下一条指令的PC，再从I-cache中取指；

    2.   译码（decode）：识别指令类型、操作数及控制信号；

    3.   寄存器重命名（rename）：寄存器重命名使得处理器可调度更多指令并行执行，通过表格存储ARF和PRF的映射关系、未使用的PRF等信息，分析并标记RAW相关性的指令，一般会把该步骤单独放一流水段；

    4.   分发（dispatch）：被重命名后的指令顺序写入发射队列、ROB和SB中，如果没有空间则需要在重命名阶段等待，分发可和重命名放一个流水段，也可分开；

    5.   发射（issue）：仲裁（select）电路从发射队列中选择准备好的最合适的指令送进FU执行，发射队列中还存在唤醒电路，将队列中对应的源操作数置为有效，仲裁电路和唤醒电路配合工作，是处理器中的关键路径；

    6.   读取寄存器：被仲裁电路选中的指令从PRF或旁路网络中得到操作数，旁路网络的存在使得减少PRF读端口成为可能，多端口寄存器堆访问速度慢，需要单独使用一个流水段；

    7.   执行（execute）：得到操作数后送入对应FU中执行，一般包括负责普通运算、乘累加运算、分支指令运算、load/store指令运算等FU，现代处理器还会加入负责多媒体运算如进行单指令多数据（SIMD）运算的FU；

    8.   写回（write back）：将计算结果写入PRF，还需要通过旁路网络送出，该网络布线非常重要直接影响速度，一般使用cluster结构将FU分组，同组FU紧挨，可在一个周期送出，跨组则需更多周期；

    9.   提交（commit）：ROB顺序将结果写入ARF，同时处理异常，所有异常均需到达该阶段后再进行处理以实现精确异常，指令从ROB离开后无法再修改处理器状态。