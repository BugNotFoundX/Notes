# 3 存储器（@苏阳）

- 可参考的资源

    - 虚拟存储：
        - https://zhuanlan.zhihu.com/p/681947363
        - https://zhuanlan.zhihu.com/p/148553766
    - Cache：
        - https://zhuanlan.zhihu.com/p/681885285
        - https://zhuanlan.zhihu.com/p/147661339

- 章节目录

    - 什么需要Cache?

        - 借鉴https://zhuanlan.zhihu.com/p/681885285开头

    - Cache的一般设计

        - Cache的组成：借鉴https://zhuanlan.zhihu.com/p/681885285

        - Cache写入：借鉴https://zhuanlan.zhihu.com/p/147661339

        - 替换策略：借鉴https://zhuanlan.zhihu.com/p/147661339

        - 流水线：借鉴https://zhuanlan.zhihu.com/p/147661339的2.1.1. Cache的组成方式内容

            介绍并行和串行访问

        - 状态机设计？？？有点工程化，先忽略

    - 虚拟存储

        - 为什么需要虚拟存储器？：借鉴https://zhuanlan.zhihu.com/p/681947363开头

            ```
            虚拟存储器优点总结如下：
            
            1）让每个程序都有独立的遍及全部虚拟地址范围的地址空间，而且可以对程序进行保护和共享，直接使用物理地址需要在编写程序时对地址进行限制且难以保护及共享；
            
            2）可将不连续PA空间映射为连续的VA空间，减少碎片，最大限度利用物理内存；
            
            3）为多个进程分配的物理内存之和可能大于实际物理内存，但实际为进程分配的只是虚拟存储器的页，可存于物理内存或下一级硬盘中（硬盘中这部分空间称为swap空间），需要用到swap空间的页时再进行加载；
            
            4）利用虚拟存储器可管理每个页的访问权限，单纯物理内存不具备权限属性，而操作系统要求在物理内存中实现不同的访问权限，权限管理可通过在页表中设置每页的属性来实现，操作系统和MMU可由此控制每页的访问权限。
            ```

        - 地址翻译：介绍单级和多级页表

            - ref https://zhuanlan.zhihu.com/p/681947363 1.1地址转化问题
            - ref https://zhuanlan.zhihu.com/p/1485537663.1. 地址转换

        - TLB设计：

            - ref：https://zhuanlan.zhihu.com/p/148553766 3.3.1. TLB设计

        - 将TLB和Cache放入流水线

            - ref：https://zhuanlan.zhihu.com/p/148553766 3.3.3. 将TLB和Cache放入流水线
            - 注重讲Virtually-Indexed，Physically-Tagged 其他两种方式一笔带过

## 3.1 什么需要Cache

-   程序一般有一定特点：指令和数据分别都有**时间相关性**和**空间相关性**。

    -   时间相关性：时间相关性指的是指令或数据在时间上的相邻性，即某个时间点访问的指令或数据很可能在不久之后再次被访问。

        -   指令的时间相关性：在程序执行过程中，循环结构是造成指令时间相关性的主要原因。例如：

            ```c
            for (int i = 0; i < 10; i++) {
                sum += array[i];
            }
            ```

            在这个循环中，循环体的指令会被多次执行，从而体现出强烈的时间相关性。处理器可以利用指令缓存（instruction cache）来存储这些频繁访问的指令，从而减少从主存加载指令的时间，提高执行效率。

        -   数据的时间相关性：数据的时间相关性指的是某个数据在被访问后，可能在短时间内再次被访问。例如：

            ```c
            int a = array[5];
            array[5] = a + 1;
            ```

            在上述代码中，`array[5]`在短时间内被多次访问。数据缓存（data cache）可以存储这些数据，以加快访问速度。

    -   空间相关性：空间相关性指的是在存储器中的相邻位置的数据或指令很可能在相近的时间被访问。

        -   指令的空间相关性：在程序执行过程中，指令通常是顺序存储和顺序执行的。例如：

            ```c
            int a = 1;
            int b = 2;
            int c = a + b;
            ```

            这些指令在存储器中是顺序存储的，处理器会顺序读取这些指令执行，从而体现出空间相关性。指令缓存可以一次加载多条顺序存储的指令，提高指令的预取效率。

        -   数据的空间相关性：数据的空间相关性指的是相邻存储位置的数据很可能在相近的时间被访问。例如：

            ```c
            for (int i = 0; i < 10; i++) {
                sum += array[i];
            }
            ```

            在这个循环中，数组`array`中的相邻元素会被顺序访问，从而体现出数据的空间相关性。数据缓存可以利用这一点，通过一次加载多个相邻的数据来提高访问速度。

-   存储器的“访问速度”的提升速度要慢于处理器的“访问速度”的提升速度

    -   一般而言，从高层往低层走，存储设备变得更慢、更便宜和更大。

        -   在最高层(L0)，是少量快速的CPU寄存器，CPU可以在一个时钟周期内访问它们。
        -   接下来是一个或多个小型到中型的基于SRAM的高速缓存存储器，可以在几个CPU时钟周期内访问它们。
        -   然后是一个大的基于DRAM的贮存，可以在几十到几百个时钟周期内访问它们。
        -   接下来是慢速但容量很大的本地磁盘。
        -   最后，有些系统包括了远程服务器上的磁盘，要通过网络来访问它们。

        ![memory_hierarchy](./assets/memory_hierarchy.png)

-   因此，如果将程序信息保存在Cache里，那么根据局部性原理，接下来的程序访问大概率能在Cache种取得数据，就无需访问memory，这样能减少memory阻塞流水线运行的情况。

-   那么Cache是什么？广义的Cache可以认为L~n-1~就是L~n~的Cache，如DDR就是磁盘或flash的Cache，L2 Cache可以看作是DDR的Cache，L1看作是L2的Cache。这里先约定下，后面所说的Cache，主要指处理器内部的Cache，即DDR的Cache。